<!DOCTYPE html>
<html>
<head>
    {% load static %}

    <title class="dashboard-title">Expense Dashboard</title>
    <div class="row text-center mb-4 dashboard-kpis">

    <div class="col-md-3">
        <div class="kpi-card">
            <h5>Total Records</h5>
            <p>{{ total_rows }}</p>
        </div>
    </div>

    <div class="col-md-3">
        <div class="kpi-card">
            <h5>Accuracy</h5>
            <p>{{ accuracy }}%</p>
        </div>
    </div>

    <div class="col-md-3">
        <div class="kpi-card">
            <h5>Max Category</h5>
            <p>{{ top_class }}</p>
        </div>
    </div>

    <div class="col-md-3">
        <div class="kpi-card">
            <h5>Model</h5>
            <p>{{ model_name }}</p>
        </div>
    </div>

</div>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="{% static 'css/dashboard.css' %}" rel="stylesheet">

</head>

<body class="dashboard-body">
<div class="container mt-5">
    <h1 class="text-center mb-4">Expense Classifier Dashboard</h1>
    <hr>

    <div class="row">

        <!-- Confusion Matrix Image -->
        <div class="col-md-6">
            <h4>Confusion Matrix</h4>
            <img src="/static/plots/{{ confusion_png }}" class="img-fluid shadow rounded">
        </div>

        <!-- Pie -->
        <div class="col-md-6">
            <h4>Class Distribution</h4>
            <canvas id="pieChart"></canvas>
        </div>

    </div>
    <hr>
<h4 class="mt-4">Monthly Spend Trend</h4>
<canvas id="monthlyChart"></canvas>

<hr>
<h4 class="mt-4">Spend by Expense Type</h4>
<canvas id="categoryChart"></canvas>

    <hr>

    <!-- Recall -->
    <h4 class="mt-4">Recall per Class</h4>
    <canvas id="recallChart"></canvas>

</div>


<script>
/* Django -> JS */
const labels = JSON.parse('{{ labels|escapejs }}');
const classDist = JSON.parse('{{ distribution|escapejs }}');
const recallVals = JSON.parse('{{ recall|escapejs }}');

/* Pie */
new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
        labels: labels,
        datasets: [{
            data: classDist,
            backgroundColor: ['#3e95cd','#8e5ea2','#3cba9f']
        }]
    },
    options: {
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context){
                        let total = classDist.reduce((a,b)=>a+b,0);
                        let val = context.raw;
                        let percent = (val / total * 100).toFixed(1);
                        return `${context.label}: ${percent}% (${val})`;
                    }
                }
            }
        }
    }
});

/* Recall */
new Chart(document.getElementById('recallChart'), {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Recall %',
            data: recallVals,
            backgroundColor: '#3cba9f'
        }]
    },
    options: {
        scales:{
            y:{ beginAtZero:true, max:100 }
        }
    }
});
// Monthly Line
new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
        labels: JSON.parse('{{ monthly_labels|escapejs }}'),
        datasets: [{
            label: "Monthly Spend",
            data: JSON.parse('{{ monthly_values|escapejs }}'),
            borderWidth: 2,
            tension: 0.3
        }]
    }
});

// Category Bar
new Chart(document.getElementById('categoryChart'), {
    type: 'bar',
    data: {
        labels: JSON.parse('{{ cat_labels|escapejs }}'),
        datasets: [{
            label: "Spend",
            data: JSON.parse('{{ cat_values|escapejs }}'),
            borderWidth: 2
        }]
    },
});

</script>


</body>
</html>
